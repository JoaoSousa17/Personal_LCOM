#include "font.h"
#include "videocard.h"
#include <lcom/lcf.h>
#include <string.h>

/* Simple 8x8 bitmap font - ASCII characters 32-126 */
static const uint8_t font_8x8[95][8] = {
  /* Space (32) */
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
  /* ! (33) */
  {0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00},
  /* " (34) */
  {0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
  /* # (35) */
  {0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00},
  /* $ (36) */
  {0x0C, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x0C, 0x00},
  /* % (37) */
  {0x00, 0x63, 0x33, 0x18, 0x0C, 0x66, 0x63, 0x00},
  /* & (38) */
  {0x1C, 0x36, 0x1C, 0x6E, 0x3B, 0x33, 0x6E, 0x00},
  /* ' (39) */
  {0x06, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00},
  /* ( (40) */
  {0x18, 0x0C, 0x06, 0x06, 0x06, 0x0C, 0x18, 0x00},
  /* ) (41) */
  {0x06, 0x0C, 0x18, 0x18, 0x18, 0x0C, 0x06, 0x00},
  /* * (42) */
  {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00},
  /* + (43) */
  {0x00, 0x0C, 0x0C, 0x3F, 0x0C, 0x0C, 0x00, 0x00},
  /* , (44) */
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x06, 0x00},
  /* - (45) */
  {0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00},
  /* . (46) */
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00},
  /* / (47) */
  {0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00},
  /* 0 (48) */
  {0x3E, 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x3E, 0x00},
  /* 1 (49) */
  {0x0C, 0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F, 0x00},
  /* 2 (50) */
  {0x1E, 0x33, 0x30, 0x1C, 0x06, 0x33, 0x3F, 0x00},
  /* 3 (51) */
  {0x1E, 0x33, 0x30, 0x1C, 0x30, 0x33, 0x1E, 0x00},
  /* 4 (52) */
  {0x38, 0x3C, 0x36, 0x33, 0x7F, 0x30, 0x78, 0x00},
  /* 5 (53) */
  {0x3F, 0x03, 0x1F, 0x30, 0x30, 0x33, 0x1E, 0x00},
  /* 6 (54) */
  {0x1C, 0x06, 0x03, 0x1F, 0x33, 0x33, 0x1E, 0x00},
  /* 7 (55) */
  {0x3F, 0x33, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x00},
  /* 8 (56) */
  {0x1E, 0x33, 0x33, 0x1E, 0x33, 0x33, 0x1E, 0x00},
  /* 9 (57) */
  {0x1E, 0x33, 0x33, 0x3E, 0x30, 0x18, 0x0E, 0x00},
  /* : (58) */
  {0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x00},
  /* ; (59) */
  {0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x06, 0x00},
  /* < (60) */
  {0x18, 0x0C, 0x06, 0x03, 0x06, 0x0C, 0x18, 0x00},
  /* = (61) */
  {0x00, 0x00, 0x3F, 0x00, 0x00, 0x3F, 0x00, 0x00},
  /* > (62) */
  {0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00},
  /* ? (63) */
  {0x1E, 0x33, 0x30, 0x18, 0x0C, 0x00, 0x0C, 0x00},
  /* @ (64) */
  {0x3E, 0x63, 0x7B, 0x7B, 0x7B, 0x03, 0x1E, 0x00},
  /* A (65) */
  {0x0C, 0x1E, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x00},
  /* B (66) */
  {0x3F, 0x66, 0x66, 0x3E, 0x66, 0x66, 0x3F, 0x00},
  /* C (67) */
  {0x3C, 0x66, 0x03, 0x03, 0x03, 0x66, 0x3C, 0x00},
  /* D (68) */
  {0x1F, 0x36, 0x66, 0x66, 0x66, 0x36, 0x1F, 0x00},
  /* E (69) */
  {0x7F, 0x46, 0x16, 0x1E, 0x16, 0x46, 0x7F, 0x00},
  /* F (70) */
  {0x7F, 0x46, 0x16, 0x1E, 0x16, 0x06, 0x0F, 0x00},
  /* G (71) */
  {0x3C, 0x66, 0x03, 0x03, 0x73, 0x66, 0x7C, 0x00},
  /* H (72) */
  {0x33, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x33, 0x00},
  /* I (73) */
  {0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00},
  /* J (74) */
  {0x78, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E, 0x00},
  /* K (75) */
  {0x67, 0x66, 0x36, 0x1E, 0x36, 0x66, 0x67, 0x00},
  /* L (76) */
  {0x0F, 0x06, 0x06, 0x06, 0x46, 0x66, 0x7F, 0x00},
  /* M (77) */
  {0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x00},
  /* N (78) */
  {0x63, 0x67, 0x6F, 0x7B, 0x73, 0x63, 0x63, 0x00},
  /* O (79) */
  {0x1C, 0x36, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x00},
  /* P (80) */
  {0x3F, 0x66, 0x66, 0x3E, 0x06, 0x06, 0x0F, 0x00},
  /* Q (81) */
  {0x1E, 0x33, 0x33, 0x33, 0x3B, 0x1E, 0x38, 0x00},
  /* R (82) */
  {0x3F, 0x66, 0x66, 0x3E, 0x36, 0x66, 0x67, 0x00},
  /* S (83) */
  {0x1E, 0x33, 0x07, 0x0E, 0x38, 0x33, 0x1E, 0x00},
  /* T (84) */
  {0x3F, 0x2D, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00},
  /* U (85) */
  {0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3F, 0x00},
  /* V (86) */
  {0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00},
  /* W (87) */
  {0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00},
  /* X (88) */
  {0x63, 0x63, 0x36, 0x1C, 0x1C, 0x36, 0x63, 0x00},
  /* Y (89) */
  {0x33, 0x33, 0x33, 0x1E, 0x0C, 0x0C, 0x1E, 0x00},
  /* Z (90) */
  {0x7F, 0x63, 0x31, 0x18, 0x4C, 0x66, 0x7F, 0x00},
  /* [ (91) */
  {0x1E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x1E, 0x00},
  /* \ (92) */
  {0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40, 0x00},
  /* ] (93) */
  {0x1E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1E, 0x00},
  /* ^ (94) */
  {0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00},
  /* _ (95) */
  {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF},
  /* ` (96) */
  {0x0C, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},
  /* a (97) */
  {0x00, 0x00, 0x1E, 0x30, 0x3E, 0x33, 0x6E, 0x00},
  /* b (98) */
  {0x07, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x3B, 0x00},
  /* c (99) */
  {0x00, 0x00, 0x1E, 0x33, 0x03, 0x33, 0x1E, 0x00},
  /* d (100) */
  {0x38, 0x30, 0x30, 0x3e, 0x33, 0x33, 0x6E, 0x00},
  /* e (101) */
  {0x00, 0x00, 0x1E, 0x33, 0x3f, 0x03, 0x1E, 0x00},
  /* f (102) */
  {0x1C, 0x36, 0x06, 0x0f, 0x06, 0x06, 0x0F, 0x00},
  /* g (103) */
  {0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x1F},
  /* h (104) */
  {0x07, 0x06, 0x36, 0x6E, 0x66, 0x66, 0x67, 0x00},
  /* i (105) */
  {0x0C, 0x00, 0x0E, 0x0C, 0x0C, 0x0C, 0x1E, 0x00},
  /* j (106) */
  {0x30, 0x00, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E},
  /* k (107) */
  {0x07, 0x06, 0x66, 0x36, 0x1E, 0x36, 0x67, 0x00},
  /* l (108) */
  {0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00},
  /* m (109) */
  {0x00, 0x00, 0x33, 0x7F, 0x7F, 0x6B, 0x63, 0x00},
  /* n (110) */
  {0x00, 0x00, 0x1F, 0x33, 0x33, 0x33, 0x33, 0x00},
  /* o (111) */
  {0x00, 0x00, 0x1E, 0x33, 0x33, 0x33, 0x1E, 0x00},
  /* p (112) */
  {0x00, 0x00, 0x3B, 0x66, 0x66, 0x3E, 0x06, 0x0F},
  /* q (113) */
  {0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x78},
  /* r (114) */
  {0x00, 0x00, 0x3B, 0x6E, 0x66, 0x06, 0x0F, 0x00},
  /* s (115) */
  {0x00, 0x00, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x00},
  /* t (116) */
  {0x08, 0x0C, 0x3E, 0x0C, 0x0C, 0x2C, 0x18, 0x00},
  /* u (117) */
  {0x00, 0x00, 0x33, 0x33, 0x33, 0x33, 0x6E, 0x00},
  /* v (118) */
  {0x00, 0x00, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00},
  /* w (119) */
  {0x00, 0x00, 0x63, 0x6B, 0x7F, 0x7F, 0x36, 0x00},
  /* x (120) */
  {0x00, 0x00, 0x63, 0x36, 0x1C, 0x36, 0x63, 0x00},
  /* y (121) */
  {0x00, 0x00, 0x33, 0x33, 0x33, 0x3E, 0x30, 0x1F},
  /* z (122) */
  {0x00, 0x00, 0x3F, 0x19, 0x0C, 0x26, 0x3F, 0x00},
  /* { (123) */
  {0x38, 0x0C, 0x0C, 0x07, 0x0C, 0x0C, 0x38, 0x00},
  /* | (124) */
  {0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00},
  /* } (125) */
  {0x07, 0x0C, 0x0C, 0x38, 0x0C, 0x0C, 0x07, 0x00},
  /* ~ (126) */
  {0x6E, 0x3B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

/* External video memory pointer - must be set by videocard module */
extern void *video_mem;

void font_init() {
  /* Nothing to initialize for this simple font system */
}

int draw_pixel(uint16_t x, uint16_t y, uint32_t color) {
  if (x >= get_h_res() || y >= get_v_res()) {
    return 1; /* Out of bounds */
  }
  
  uint8_t bytes_per_pixel = (get_bits_per_pixel() + 7) / 8;
  uint8_t *pixel_ptr = (uint8_t *)video_mem + (y * get_h_res() + x) * bytes_per_pixel;
  
  /* Write color based on bits per pixel */
  switch (get_bits_per_pixel()) {
    case 8:
      *pixel_ptr = (uint8_t)color;
      break;
    case 15:
    case 16:
      *(uint16_t *)pixel_ptr = (uint16_t)color;
      break;
    case 24:
      pixel_ptr[0] = (uint8_t)(color & 0xFF);       /* Blue */
      pixel_ptr[1] = (uint8_t)((color >> 8) & 0xFF);  /* Green */
      pixel_ptr[2] = (uint8_t)((color >> 16) & 0xFF); /* Red */
      break;
    case 32:
      *(uint32_t *)pixel_ptr = color;
      break;
    default:
      return 1; /* Unsupported color depth */
  }
  
  return 0;
}

int draw_char(uint16_t x, uint16_t y, char ch, uint32_t color) {
  /* Check if character is printable */
  if (ch < 32 || ch > 126) {
    ch = '?'; /* Replace unprintable chars with '?' */
  }
  
  /* Get font data for the character */
  const uint8_t *char_data = font_8x8[ch - 32];
  
  /* Draw each row of the character */
  for (int row = 0; row < 8; row++) {
    uint8_t byte = char_data[row];
    
    /* Draw each pixel in the row */
    for (int col = 0; col < 8; col++) {
      if (byte & (0x80 >> col)) { /* Check if bit is set (MSB first) */
        if (draw_pixel(x + col, y + row, color) != 0) {
          return 1; /* Failed to draw pixel */
        }
      }
    }
  }
  
  return 0;
}

int draw_string(uint16_t x, uint16_t y, const char *str, uint32_t color) {
  if (str == NULL) {
    return 1;
  }
  
  uint16_t current_x = x;
  
  /* Draw each character in the string */
  while (*str != '\0') {
    if (*str == '\n') {
      /* Handle newline */
      current_x = x;
      y += 8; /* Move to next line (8 pixels down) */
    } else if (*str == '\t') {
      /* Handle tab - move to next 4-character boundary */
      current_x = ((current_x - x) / 32 + 1) * 32 + x;
    } else {
      /* Draw regular character */
      if (draw_char(current_x, y, *str, color) != 0) {
        return 1; /* Failed to draw character */
      }
      current_x += 8; /* Move to next character position */
    }
    
    /* Check if we need to wrap to next line */
    if (current_x + 8 > get_h_res()) {
      current_x = x;
      y += 8;
    }
    
    /* Check if we're past the bottom of the screen */
    if (y + 8 > get_v_res()) {
      break; /* Stop drawing if we're off screen */
    }
    
    str++;
  }
  
  return 0;
}

int clear_screen(uint32_t color) {
  uint16_t h_res = get_h_res();
  uint16_t v_res = get_v_res();
  
  for (uint16_t y = 0; y < v_res; y++) {
    for (uint16_t x = 0; x < h_res; x++) {
      if (draw_pixel(x, y, color) != 0) {
        return 1;
      }
    }
  }
  
  return 0;
}